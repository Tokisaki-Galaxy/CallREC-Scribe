<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:CallREC_Scribe.ViewModels"
             xmlns:models="clr-namespace:CallREC_Scribe.Models"
             xmlns:converters="clr-namespace:CallREC_Scribe.Converters"
             xmlns:strings="clr-namespace:CallREC_Scribe.Resources.Strings"
             x:DataType="viewmodels:MainPageViewModel"
             x:Class="CallREC_Scribe.MainPage"
             Title="{x:Static strings:AppResources.AppName}">

    <ContentPage.Resources>
        <converters:TranscriptionStatusConverter x:Key="TranscriptionStatusConv" />
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto, Auto, Auto, *, Auto" Padding="10" RowSpacing="10">

        <!-- 语音识别配置按钮 -->
        <HorizontalStackLayout Grid.Row="0" Spacing="10">
            <Button Text="{x:Static strings:AppResources.ConfigureApi}" Command="{Binding ConfigureApiCommand}" HorizontalOptions="FillAndExpand"/>
            <Button Text="{x:Static strings:AppResources.ConfigureParsing}" Command="{Binding ConfigureParsingCommand}" HorizontalOptions="FillAndExpand"/>
            <!--<Button Text="Test FFmpeg Callback" Command="{Binding TestFFmpegCommand}" HorizontalOptions="FillAndExpand"/>-->
        </HorizontalStackLayout>

        <!-- 语音保存位置 -->
        <Grid Grid.Row="1" ColumnDefinitions="*, Auto" ColumnSpacing="10">
            <Frame Padding="10,0" CornerRadius="5" BorderColor="LightGray">
                <Label Text="{Binding RecordingsFolder}" VerticalOptions="Center"/>
            </Frame>
            <Button Grid.Column="1" Text="{x:Static strings:AppResources.Browse}" Command="{Binding BrowseFolderCommand}"/>
        </Grid>

        <!-- 转译和选择按钮 -->
        <HorizontalStackLayout Grid.Row="2" Spacing="10">
            <Button Text="{x:Static strings:AppResources.TranscribeSelected}" Command="{Binding TranscribeSelectedCommand}" HorizontalOptions="FillAndExpand" />
            <Button Text="{x:Static strings:AppResources.SelectAll}" Command="{Binding SelectAllCommand}" />
            <Button Text="{x:Static strings:AppResources.InvertSelection}" Command="{Binding InvertSelectionCommand}" />
            <Button Text="{x:Static strings:AppResources.Export}" Command="{Binding ExportCommand}" />
            <Button Text="{x:Static strings:AppResources.DeleteSelected}" Command="{Binding DeleteSelectedCommand}" BackgroundColor="Red" TextColor="White"/>
        </HorizontalStackLayout>

        <!-- 录音文件表格 -->
        <CollectionView Grid.Row="3" ItemsSource="{Binding RecordingFiles}"
                        SelectionMode="None">
            <CollectionView.Header>
                <Grid ColumnDefinitions="Auto, *, *, *" Padding="5, 10" BackgroundColor="LightGray">
                    <Label Grid.Column="1" Text="{x:Static strings:AppResources.Header_Date}" FontAttributes="Bold"/>
                    <Label Grid.Column="2" Text="{x:Static strings:AppResources.Header_PhoneNumber}" FontAttributes="Bold"/>
                    <Label Grid.Column="3" Text="{x:Static strings:AppResources.Header_TranscriptionPreview}" FontAttributes="Bold"/>
                </Grid>
            </CollectionView.Header>
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:RecordingFile">
                    <Grid ColumnDefinitions="Auto, *, *, *" Padding="5" ColumnSpacing="5">
                        <Grid.GestureRecognizers>
                            <TapGestureRecognizer 
                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainPageViewModel}}, Path=ToggleSelectionCommand}"
                                CommandParameter="{Binding .}"/>
                        </Grid.GestureRecognizers>

                        <!-- IsHitTestVisible="False" 防止重复触发点击事件 -->
                        <CheckBox Grid.Column="0" IsChecked="{Binding IsSelected}" VerticalOptions="Center" InputTransparent="True"/>
                        <Label Grid.Column="1" Text="{Binding RecordingDate, StringFormat='{0:yyyy-MM-dd HH:mm}'}" VerticalOptions="Center"/>
                        <Label Grid.Column="2" Text="{Binding PhoneNumber}" VerticalOptions="Center"/>
                        <Label Grid.Column="3" Text="{Binding TranscriptionPreview, Converter={StaticResource TranscriptionStatusConv}}" LineBreakMode="TailTruncation" VerticalOptions="Center"/>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- 加载指示器 -->
        <Border Grid.Row="0" Grid.RowSpan="5"
        StrokeThickness="0"
        BackgroundColor="#80000000" 
        IsVisible="{Binding IsBusy}"
        Padding="20">
            <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="10">

                <ActivityIndicator IsRunning="{Binding IsBusy}"
                           Color="White"/>

                <Label Text="{Binding CurrentTaskDescription}"
               TextColor="White"
               FontSize="16"
               HorizontalTextAlignment="Center"/>

            </VerticalStackLayout>
        </Border>

    </Grid>
</ContentPage>